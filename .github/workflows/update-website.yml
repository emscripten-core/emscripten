name: Update website

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  update-website:
    name: Update website
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.EMSCRIPTEN_BOT_TOKEN }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - name: Checkout website repo
        uses: actions/checkout@v4
        with:
          repository: kripken/emscripten-site
          ref: gh-pages
          path: site/emscripten-site
          token: ${{ secrets.EMSCRIPTEN_BOT_TOKEN }}
      - name: pip install
        run: |
          which python3
          python3 --version
          python3 -m pip install -r requirements-dev.txt
      - name: Update docs
        run: |
          set -o errexit
          set -o xtrace
          git config --global user.name emscripten-bot
          git config --global user.email emscripten-bot@users.noreply.github.com
          if ./tools/maint/update_docs.py; then
             echo "update_docs.py returned zero, expectations up-to-date"
             # Exit early and don't create a PR
             exit 0
          else
            code=$?
            if [[ $code != 2 ]] ; then
               echo "update_docs.py failed with unexpected error $code (expected 2)"
               exit 1
            fi
          fi
          # Create a PR against the emscripten-site repo
          cd site/emscripten-site
          git push -f origin update
          gh pr create --fill --head update --base gh-pages --reviewer sbc100,kripken
          # TODO: Enable this once we figure out how to enforce review
          # requirment
          #gh pr merge --squash --auto
